{% extends "base.html" %}

{% block title %}Helm Chart Generator | NSF NCAR CIRRUS{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-10 mx-auto text-center">
                <h1 class="page-title">Modular Helm Chart Generator</h1>
                <p class="page-description">
                    Build your custom Helm chart by selecting the components you need
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="content-wrapper">
        <form id="helmGeneratorForm">
            
            <!-- Base Application Configuration -->
            <section class="mb-5">
                <h2 class="section-heading">
                    <i class="fas fa-cube"></i> Base Application
                </h2>
                <p class="text-muted mb-4">Required fields for your containerized application</p>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="app_name" class="form-label">Application Name *</label>
                        <input type="text" class="form-control" id="app_name" name="app_name" 
                               placeholder="my-app" pattern="[a-z0-9\-]+" required>
                        <small class="text-muted">Lowercase letters, numbers, and hyphens only</small>
                    </div>

                    <div class="col-md-6">
                        <label for="image" class="form-label">Container Image *</label>
                        <input type="text" class="form-control" id="image" name="image" 
                               placeholder="hub.k8s.ucar.edu/your-project/your-app:v1.0" required>
                        <small class="text-muted">Full image path including tag</small>
                    </div>

                    <div class="col-md-6">
                        <label for="replicas" class="form-label">Replicas *</label>
                        <input type="number" class="form-control" id="replicas" name="replicas" 
                               value="2" min="1" max="100" required>
                        <small class="text-muted">Recommended: 2+ for zero-downtime during server maintenance</small>
                    </div>

                    <div class="col-md-6">
                        <label for="port" class="form-label">Container Port *</label>
                        <input type="number" class="form-control" id="port" name="port" 
                               value="8080" min="1" max="65535" required>
                    </div>

                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enable_ingress" name="enable_ingress">
                            <label class="form-check-label" for="enable_ingress">
                                <strong>Enable Web Access (Ingress)</strong>
                                <p class="small text-muted mb-0">Expose your application with a URL</p>
                            </label>
                        </div>
                    </div>

                    <div class="col-md-4" id="ingressTypeField" style="display: none;">
                        <label for="ingress_type" class="form-label">Access Type *</label>
                        <select class="form-select" id="ingress_type" name="ingress_type">
                            <option value="external">External (nginx-external)</option>
                            <option value="internal">Internal UCAR Only (nginx-internal)</option>
                        </select>
                        <small class="text-muted">Internal access requires UCAR network/VPN</small>
                    </div>

                    <div class="col-md-4" id="domainField" style="display: none;">
                        <label for="domain" class="form-label">Domain *</label>
                        <input type="text" class="form-control" id="domain" name="domain" 
                            placeholder="myapp.k8s.ucar.edu" 
                            pattern=".*\.k8s\.ucar\.edu$"
                            title="Domain must end with .k8s.ucar.edu">
                        <small class="text-muted domain-hint">Must end with <strong>.k8s.ucar.edu</strong></small>
                        <div class="invalid-feedback" id="domainError">
                            <i class="fas fa-exclamation-circle"></i> Domain must end with <strong>.k8s.ucar.edu</strong>
                        </div>
                    </div>

                    <div class="col-md-4" id="pathField" style="display: none;">
                        <label for="webapp_path" class="form-label">URL Path *</label>
                        <input type="text" class="form-control" id="webapp_path" name="webapp_path" 
                            value="/" placeholder="/">
                        <small class="text-muted">Use / for full site, or /api for API endpoints</small>
                    </div>

            <hr class="my-5">

            <!-- Add-ons Selection -->
            <section class="mb-5">
                <h2 class="section-heading">
                    <i class="fas fa-puzzle-piece"></i> Select Add-ons
                </h2>
                <p class="text-muted mb-4">Choose additional components for your application (select any combination)</p>
                
                <div class="row g-4">
                    {% for key, addon in addons.items() %}
                    <div class="col-md-6 col-lg-4">
                        <div class="addon-card">
                            <div class="form-check">
                                <input class="form-check-input addon-checkbox" type="checkbox" 
                                       id="addon_{{ key }}" value="{{ key }}" data-addon="{{ key }}">
                                <label class="form-check-label" for="addon_{{ key }}">
                                    <h5>{{ addon.name }}</h5>
                                    <p class="small text-muted mb-0">{{ addon.description }}</p>
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Add-on Configuration Sections (hidden by default) -->
            
            <!-- CloudNativePG Configuration -->
            <section class="addon-config mb-5" id="config_cnpg" style="display: none;">
                <h3 class="config-heading">
                    <i class="fas fa-server"></i> CloudNativePG Configuration
                </h3>
                
                <h5 class="mt-4 mb-3">Cluster Settings</h5>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="cnpg_instances" class="form-label">Cluster Instances</label>
                        <input type="number" class="form-control" id="cnpg_instances" name="cnpg_instances" 
                            value="3" min="1" max="10">
                        <small class="text-muted">Recommended: 3 for HA</small>
                    </div>
                    <div class="col-md-6">
                        <label for="cnpg_storage_size" class="form-label">Storage Size</label>
                        <input type="text" class="form-control" id="cnpg_storage_size" name="cnpg_storage_size" 
                            value="20Gi" pattern="[0-9]+[KMGT]i">
                    </div>
                </div>

                <h5 class="mt-4 mb-3">App User Credentials (External Secrets)</h5>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label for="cnpg_app_owner" class="form-label">App Username</label>
                        <input type="text" class="form-control" id="cnpg_app_owner" name="cnpg_app_owner" 
                            placeholder="app_user" value="app_user">
                    </div>
                    <div class="col-md-4">
                        <label for="cnpg_app_secret_path" class="form-label">OpenBao Secret Path</label>
                        <input type="text" class="form-control" id="cnpg_app_secret_path" name="cnpg_app_secret_path" 
                            placeholder="secret/data/myapp/db">
                    </div>
                    <div class="col-md-4">
                        <label for="cnpg_app_password_key" class="form-label">Password Key</label>
                        <input type="text" class="form-control" id="cnpg_app_password_key" name="cnpg_app_password_key" 
                            placeholder="password" value="password">
                    </div>
                </div>

                <div class="alert alert-warning mt-4">
                    <small>
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>SecretStore Required:</strong> 
                        A SecretStore named <code>user-ro</code> must be created by CIRRUS admin before external secrets can be accessed. 
                        Contact <a href="mailto:cirrus-admin@ucar.edu">cirrus-admin@ucar.edu</a> if you don't have one set up.
                    </small>
                </div>
            </section>

            <!-- Dask Configuration -->
            <section class="addon-config mb-5" id="config_dask" style="display: none;">
                <h3 class="config-heading">
                    <i class="fas fa-project-diagram"></i> Dask Cluster Configuration
                </h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label for="worker_replicas" class="form-label">Worker Replicas</label>
                        <input type="number" class="form-control" id="worker_replicas" name="worker_replicas" 
                               value="3" min="1" max="100">
                    </div>
                    <div class="col-md-4">
                        <label for="worker_threads" class="form-label">Worker Threads</label>
                        <input type="number" class="form-control" id="worker_threads" name="worker_threads" 
                               value="4" min="1" max="64">
                    </div>
                    <div class="col-md-4">
                        <label for="worker_memory" class="form-label">Worker Memory</label>
                        <input type="text" class="form-control" id="worker_memory" name="worker_memory" 
                               value="4Gi" pattern="[0-9]+[KMGT]i">
                    </div>
                </div>
            </section>

            <!-- Persistent Volume Configuration -->
            <section class="addon-config mb-5" id="config_persistence" style="display: none;">
                <h3 class="config-heading">
                    <i class="fas fa-hdd"></i> Persistent Volume Configuration
                </h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label for="pv_access_mode" class="form-label">Access Mode</label>
                        <select class="form-select" id="pv_access_mode" name="pv_access_mode">
                            <option value="ReadWriteOnce">RWO - Single container access</option>
                            <option value="ReadWriteMany">RWX - Multiple container access</option>
                        </select>
                        <small class="text-muted">RWO: One pod at a time | RWX: Multiple pods simultaneously</small>
                    </div>
                    <div class="col-md-4">
                        <label for="pv_storage_size" class="form-label">Storage Size</label>
                        <input type="text" class="form-control" id="pv_storage_size" name="pv_storage_size" 
                               value="10Gi" pattern="[0-9]+[KMGT]i">
                    </div>
                    <div class="col-md-4">
                        <label for="pv_mount_path" class="form-label">Mount Path</label>
                        <input type="text" class="form-control" id="pv_mount_path" name="pv_mount_path" 
                               value="/data">
                    </div>
                </div>
            </section>
                </div>
            </section>

            <!-- NFS Configuration -->
            <section class="addon-config mb-5" id="config_nfs" style="display: none;">
                <h3 class="config-heading">
                    <i class="fas fa-network-wired"></i> NFS Volume Configuration
                </h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label for="nfs_server" class="form-label">NFS Server</label>
                        <input type="text" class="form-control" id="nfs_server" name="nfs_server" 
                               placeholder="nfs.example.com">
                    </div>
                    <div class="col-md-4">
                        <label for="nfs_path" class="form-label">Export Path</label>
                        <input type="text" class="form-control" id="nfs_path" name="nfs_path" 
                               placeholder="/export/data">
                    </div>
                    <div class="col-md-4">
                        <label for="nfs_mount_path" class="form-label">Mount Path in Container</label>
                        <input type="text" class="form-control" id="nfs_mount_path" name="nfs_mount_path" 
                               value="/mnt/nfs">
                    </div>
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="nfs_readonly" name="nfs_readonly">
                            <label class="form-check-label" for="nfs_readonly">
                                <strong>Read-Only Mount</strong>
                                <p class="small text-muted mb-0">Enable for read-only access (required for Glade)</p>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    <small><i class="fas fa-info-circle"></i> <strong>For Glade access:</strong> Contact <a href="mailto:cirrus-admin@ucar.edu">cirrus-admin@ucar.edu</a> for the Glade NFS server FQDN and export policies. Set your path to <code>/glade/work/username</code> or <code>/glade/campaign/...</code> and enable read-only.</small>
                </div>
            </section>

            <!-- External Secrets Configuration -->
            <section class="addon-config mb-5" id="config_external_secrets" style="display: none;">
                <h3 class="config-heading">
                    <i class="fas fa-key"></i> External Secrets Configuration
                </h3>
                <div class="row g-4">
                    <div class="col-md-12">
                        <label for="secret_path" class="form-label">Vault Secret Path</label>
                        <input type="text" class="form-control" id="secret_path" name="secret_path" 
                               placeholder="secret/data/myapp">
                        <small class="text-muted">Path in bao.k8s.ucar.edu (e.g., secret/data/myapp)</small>
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    <small><i class="fas fa-info-circle"></i> Secrets will be injected as environment variables</small>
                </div>
            </section>

            <hr class="my-5">

            <!-- Output Options -->
            <section class="mb-5">
                <h2 class="section-heading">Output Options</h2>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="output-option-card">
                            <input type="radio" name="output_format" value="zip" id="output-zip" checked>
                            <label for="output-zip">
                                <i class="fas fa-file-archive fa-2x mb-2"></i>
                                <h5>Download as ZIP</h5>
                                <p class="small text-muted">Download the complete Helm chart as a ZIP file</p>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="output-option-card">
                            <input type="radio" name="output_format" value="github_pr" id="output-pr">
                            <label for="output-pr">
                                <i class="fab fa-github fa-2x mb-2"></i>
                                <h5>Create GitHub PR</h5>
                                <p class="small text-muted">Automatically create a pull request in your repository</p>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- GitHub PR Options -->
                <div id="githubOptions" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>GitHub Personal Access Token Required</strong>
                        <p class="mb-0 small">Create a token at <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a> with <code>repo</code> scope</p>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="github_token" class="form-label">GitHub Token</label>
                            <input type="password" class="form-control" id="github_token" name="github_token" 
                                   placeholder="ghp_...">
                        </div>
                        <div class="col-md-6">
                            <label for="github_repo" class="form-label">Repository URL</label>
                            <input type="text" class="form-control" id="github_repo" name="github_repo" 
                                   placeholder="https://github.com/your-org/your-repo">
                        </div>
                        <div class="col-md-6">
                            <label for="github_branch" class="form-label">Base Branch</label>
                            <input type="text" class="form-control" id="github_branch" name="github_branch" 
                                   value="main">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Submit Button -->
            <div class="text-center mb-5">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-rocket"></i> Generate Helm Chart
                </button>
            </div>
        </form>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" style="display: none;" class="text-center mb-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generating...</span>
            </div>
            <p class="mt-3">Generating your modular Helm chart...</p>
        </div>

        <!-- Success Message -->
        <div id="successMessage" style="display: none;" class="alert alert-success">
            <h5><i class="fas fa-check-circle"></i> Success!</h5>
            <p id="successText"></p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" style="display: none;" class="alert alert-danger">
            <h5><i class="fas fa-exclamation-circle"></i> Error</h5>
            <p id="errorText"></p>
        </div>
    </div>
</div>

<style>
.addon-card {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 1.25rem;
    transition: all 0.3s ease;
    height: 100%;
}

.addon-card:hover {
    border-color: #0066cc;
    box-shadow: 0 2px 8px rgba(0, 102, 204, 0.2);
}

.addon-card .form-check-input:checked ~ .form-check-label {
    color: #0066cc;
}

.addon-card .form-check-input:checked ~ .form-check-label h5 {
    color: #0066cc;
    font-weight: 600;
}

.addon-card .form-check-label {
    cursor: pointer;
    width: 100%;
}

.addon-config {
    background: #f8f9fa;
    border-left: 4px solid #0066cc;
    padding: 2rem;
    border-radius: 4px;
}

.config-heading {
    color: #0066cc;
    font-size: 1.25rem;
    margin-bottom: 1.5rem;
}

.output-option-card {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    height: 100%;
}

.output-option-card:hover {
    border-color: #0066cc;
    box-shadow: 0 2px 8px rgba(0, 102, 204, 0.2);
}

.output-option-card input[type="radio"] {
    display: none;
}

.output-option-card input[type="radio"]:checked + label {
    color: #0066cc;
}

.output-option-card.selected {
    border-color: #0066cc;
    background-color: #f8f9fa;
}

.output-option-card label {
    cursor: pointer;
    margin: 0;
}

.output-option-card i {
    color: #6c757d;
}

.output-option-card input[type="radio"]:checked + label i {
    color: #0066cc;
}

.page-header {
    background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
    color: white;
    padding: 4rem 0;
    margin-bottom: 3rem;
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.section-heading {
    color: #0066cc;
    font-weight: 600;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e9ecef;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('helmGeneratorForm');
    const enableIngressCheckbox = document.getElementById('enable_ingress');
    const ingressTypeField = document.getElementById('ingressTypeField');
    const domainField = document.getElementById('domainField');
    const githubOptions = document.getElementById('githubOptions');
    
    // Handle ingress toggle
    enableIngressCheckbox.addEventListener('change', function() {
        const domainInput = document.getElementById('domain');
        const ingressTypeInput = document.getElementById('ingress_type');
        const pathInput = document.getElementById('webapp_path');
        const pathField = document.getElementById('pathField');
        
        if (this.checked) {
            ingressTypeField.style.display = 'block';
            domainField.style.display = 'block';
            pathField.style.display = 'block';
            domainInput.setAttribute('required', 'required');
            ingressTypeInput.setAttribute('required', 'required');
            pathInput.setAttribute('required', 'required');
        } else {
            ingressTypeField.style.display = 'none';
            domainField.style.display = 'none';
            pathField.style.display = 'none';
            domainInput.removeAttribute('required');
            ingressTypeInput.removeAttribute('required');
            pathInput.removeAttribute('required');
        }
    });
    
    // Add domain validation feedback
    const domainInput = document.getElementById('domain');
    const domainError = document.getElementById('domainError');

    if (domainInput) {
        domainInput.addEventListener('input', function() {
            if (this.value && !this.checkValidity()) {
                domainError.style.display = 'block';
                this.classList.add('is-invalid');
            } else {
                domainError.style.display = 'none';
                this.classList.remove('is-invalid');
            }
        });
        
        domainInput.addEventListener('blur', function() {
            if (this.value && !this.checkValidity()) {
                domainError.style.display = 'block';
                this.classList.add('is-invalid');
            }
        });
    }
    
    // Handle add-on checkbox toggles
    document.querySelectorAll('.addon-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const addonKey = this.getAttribute('data-addon');
            const configSection = document.getElementById(`config_${addonKey}`);
            
            if (configSection) {
                if (this.checked) {
                    configSection.style.display = 'block';
                    // Set inputs as required
                    configSection.querySelectorAll('input, select').forEach(input => {
                        if (input.type !== 'checkbox') {
                            input.setAttribute('required', 'required');
                        }
                    });
                } else {
                    configSection.style.display = 'none';
                    // Remove required
                    configSection.querySelectorAll('input, select').forEach(input => {
                        input.removeAttribute('required');
                    });
                }
            }
        });
    });
    
    // Output format selection
    document.querySelectorAll('input[name="output_format"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.querySelectorAll('.output-option-card').forEach(c => c.classList.remove('selected'));
            this.closest('.output-option-card').classList.add('selected');
            
            const githubToken = document.getElementById('github_token');
            const githubRepo = document.getElementById('github_repo');
            
            if (this.value === 'github_pr') {
                githubOptions.style.display = 'block';
                githubToken.setAttribute('required', 'required');
                githubRepo.setAttribute('required', 'required');
            } else {
                githubOptions.style.display = 'none';
                githubToken.removeAttribute('required');
                githubRepo.removeAttribute('required');
            }
        });
    });
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        console.log('Form submitted');
        
        const formData = new FormData(form);
        const outputFormat = formData.get('output_format');
        
        // Collect enabled add-ons
        const enabledAddons = [];
        document.querySelectorAll('.addon-checkbox:checked').forEach(checkbox => {
            enabledAddons.push(checkbox.value);
        });
        
        console.log('Enabled add-ons:', enabledAddons);
        
        // Build request object
        const data = {
            output_format: outputFormat,
            enabled_addons: enabledAddons
        };
        
        // Collect all form fields
        for (let [key, value] of formData.entries()) {
            if (key !== 'output_format') {
                data[key] = value;
            }
        }
        
        // Handle checkboxes
        data.enable_ingress = document.getElementById('enable_ingress').checked;
        if (document.getElementById('nfs_readonly')) {
            data.nfs_readonly = document.getElementById('nfs_readonly').checked;
        }
        if (document.getElementById('cnpg_enable_superuser')) {
            data.cnpg_enable_superuser = document.getElementById('cnpg_enable_superuser').checked;
        }
        
        console.log('Request data:', data);
        
        // Show loading
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
        form.style.display = 'none';
        
        try {
            if (outputFormat === 'zip') {
                console.log('Fetching ZIP...');
                const response = await fetch('/api/generate-helm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${data.app_name}-helm-chart.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showSuccess('Helm chart downloaded successfully!');
                } else {
                    const error = await response.json();
                    console.error('Error response:', error);
                    showError(error.error || 'Failed to generate Helm chart');
                }
            } else {
                console.log('Creating GitHub PR...');
                const response = await fetch('/api/generate-helm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Result:', result);
                
                if (response.ok) {
                    showSuccess(`Pull request created successfully! <a href="${result.pr_url}" target="_blank">View PR</a>`);
                } else {
                    console.error('Error:', result.error);
                    showError(result.error || 'Failed to create pull request');
                }
            }
        } catch (error) {
            console.error('Exception:', error);
            showError('An unexpected error occurred: ' + error.message);
        }
        
        document.getElementById('loadingIndicator').style.display = 'none';
    });
    
    function showSuccess(message) {
        document.getElementById('successText').innerHTML = message;
        document.getElementById('successMessage').style.display = 'block';
        setTimeout(() => {
            form.style.display = 'block';
            form.reset();
            document.querySelectorAll('.addon-config').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById('successMessage').style.display = 'none';
        }, 5000);
    }
    
    function showError(message) {
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'block';
        form.style.display = 'block';
    }
});
</script>
{% endblock %}